# CFA: Continuous Factor Authentication

This bot is responsible for safely requesting and delivering a 2FA token for an `npm publish` command running on CI through `semantic-release.

## Set Up

Setting up a new repository with CFA is a multi-step process:

1. Get a `bearer` token from Slack using the `/cfa-setup owner/repo` command where `owner/repo` is the GitHub slug of the repository you wish to set up.
2. Set up [`semantic-release`](https://github.com/semantic-release/semantic-release) on your repository, you must use the `@continuous-auth/semantic-release-npm` plugin instead of the default NPM plugin.  You must configure it to use the `electron-cfa` NPM account, if you don't access to the tokens for that account please ask someone in the Security Working Group.

```js
// .releaserc.json
{
  "plugins": [
    "@semantic-release/commit-analyzer",
    "@semantic-release/release-notes-generator",
    "@continuous-auth/semantic-release-npm",
    "@semantic-release/github"
  ]
}
```

3. Set the `CFA_HOST` and `CFA_SECRET` environment variables on your CI configuration.  `CFA_SECRET` is the bearer token you just made and `CFA_HOST` is the url of the CFA deploy.
4. Commit someething to the `master` branch of your repository and watch CFA go to work.  It will ping you in `#bot-cfa` to ask for a OTP.

An example of a set up repository can be viewed at [`electron-winstaller`](https://github.com/electron/windows-installer).

## What does it look like?

Something like this:

![CFA Example](docs/example.png)

## How does it work?

At a high level CFA is just a proxy for 2FA, in a 2FA model there is "something you know" and "something you have".  In the CFA model the "something you know" is still your NPM auth token, and the "something you have" is still the OTP generator.  CFA just safely mediates a connection between the CI build and you by validating the CI build through both the `bearer` token and by forcing the CI build to "prove" it is actually asking for a token.

Included below is a flow diagram which explains what CFA verifies and how it verifies it.  Other important parts of the code for this verification process can be found in [`src/server/api/proof/providers/circleci-utils.ts`](src/server/api/proof/providers/circleci-utils.ts).

![Proof Process](./docs/proof-process.png)

## Heroku Configuration

The following environment variables need to be set:

 * `PORT`: Which port to run on (`3000` by default)
 * `SLACK_TOKEN`: Slack app token
 * `SLACK_SIGNING_SECRET`: Slack app signing secret
 * `SLACK_CHANNEL`: Slack channel for the bot to post to (copy the link and take the id)
 * `GITHUB_CLIENT_SECRET`: GitHub token that allows `electron-bot` to clone `electron`
 * `GITHUB_CLIENT_ID`: Same GitHub token as above

Optional variables:

 * `DEBUG`: Used by tons of modules used by the bot, set it to `*` for verbose output
 * `DATABASE_URL`: In prod, use this to set a postgres connection URL